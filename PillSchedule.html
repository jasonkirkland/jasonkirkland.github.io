<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pill Reminder App (Firebase)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Pill Reminder</h1>
    <div id="auth-container">
        <button id="signin-button" onclick="signIn()">Sign In</button>
        <button id="signout-button" onclick="signOut()" style="display:none;">Sign Out</button>
    </div>
    <div id="upcoming-pills"></div>

    <script>
        // Replace with your Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Firebase Auth and Database references
        const auth = firebase.auth();
        const database = firebase.database();

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('signin-button').style.display = 'none';
                document.getElementById('signout-button').style.display = 'inline-block';
                fetchMedications();
            } else {
                document.getElementById('signin-button').style.display = 'inline-block';
                document.getElementById('signout-button').style.display = 'none';
                document.getElementById('upcoming-pills').innerHTML = '';
            }
        });

        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        }

        function signOut() {
            auth.signOut();
        }

        function fetchMedications() {
            const userId = auth.currentUser.uid;
            const medicationsRef = database.ref('medications/' + userId);
            
            medicationsRef.on('value', (snapshot) => {
                const medications = snapshot.val();
                if (medications) {
                    const now = moment();
                    const upcomingMeds = Object.entries(medications)
                        .filter(([_, med]) => {
                            const scheduledTime = moment(med.scheduledTime, 'HH:mm');
                            return scheduledTime.isAfter(now);
                        })
                        .sort((a, b) => moment(a[1].scheduledTime, 'HH:mm').diff(moment(b[1].scheduledTime, 'HH:mm')));
                    displayMedications(upcomingMeds);
                } else {
                    document.getElementById('upcoming-pills').innerHTML = '<p>No medications found.</p>';
                }
            });
        }

        function displayMedications(medications) {
            const container = document.getElementById('upcoming-pills');
            container.innerHTML = '<h2>Upcoming Medications:</h2>';
            const list = document.createElement('ul');

            medications.forEach(([id, med]) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <strong>${med.name}</strong> - ${med.dosage}
                    <br>Time: ${med.scheduledTime}
                    <br><button onclick="markAsTaken('${id}', '${med.name}', '${med.scheduledTime}')">Mark as Taken</button>
                `;
                list.appendChild(listItem);
            });

            container.appendChild(list);
        }

        function markAsTaken(medId, medName, scheduledTime) {
            const userId = auth.currentUser.uid;
            const now = moment().format('YYYY-MM-DD HH:mm:ss');
            
            database.ref('medicationLogs/' + userId).push({
                medicationId: medId,
                name: medName,
                scheduledTime: scheduledTime,
                takenAt: now
            }).then(() => {
                alert(`${medName} marked as taken!`);
            }).catch((error) => {
                console.error('Error logging data:', error);
            });
        }
    </script>
</body>
</html>
