<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWS Weather Data – Denton, TX</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 16px;
        }
        h1 {
            font-size: 1.4rem;
            color: #58a6ff;
            margin: 0 0 4px;
        }
        .subtitle {
            font-size: 0.85rem;
            color: #8b949e;
            margin-bottom: 20px;
        }
        #status {
            font-size: 0.85rem;
            color: #8b949e;
            margin-bottom: 16px;
            min-height: 1.2em;
        }
        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .section-header {
            background: #21262d;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #58a6ff;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-header .endpoint a {
            color: #58a6ff;
            text-decoration: none;
        }
        .section-header .endpoint a:hover {
            text-decoration: underline;
        }
        .section-header .endpoint {
            font-size: 0.72rem;
            color: #8b949e;
            font-weight: normal;
            font-family: monospace;
            word-break: break-all;
        }
        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1px;
            background: #30363d;
        }
        .field {
            background: #161b22;
            padding: 10px 14px;
        }
        .field-label {
            font-size: 0.72rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 3px;
        }
        .field-value {
            font-size: 0.92rem;
            color: #e6edf3;
            word-break: break-word;
        }
        .field-value.highlight {
            color: #79c0ff;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .field-value.null {
            color: #484f58;
            font-style: italic;
        }
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1px;
            background: #30363d;
        }
        .forecast-period {
            background: #161b22;
            padding: 12px 14px;
        }
        .period-name {
            font-size: 0.85rem;
            font-weight: bold;
            color: #79c0ff;
            margin-bottom: 6px;
        }
        .period-temp {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .period-temp.day { color: #ff7b72; }
        .period-temp.night { color: #79c0ff; }
        .period-short {
            font-size: 0.82rem;
            color: #8b949e;
            margin-bottom: 4px;
        }
        .period-wind {
            font-size: 0.78rem;
            color: #6e7681;
        }
        .period-detail {
            font-size: 0.78rem;
            color: #8b949e;
            margin-top: 6px;
            line-height: 1.4;
        }
        .raw-toggle {
            font-size: 0.75rem;
            color: #58a6ff;
            cursor: pointer;
            background: none;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 2px 8px;
            margin-left: 8px;
        }
        .raw-toggle:hover { background: #21262d; }
        .raw-json {
            display: none;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #8b949e;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid #30363d;
        }
        .updated-at {
            font-size: 0.78rem;
            color: #6e7681;
            text-align: right;
            margin-top: 8px;
        }
        button#refresh {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-bottom: 16px;
        }
        button#refresh:hover { background: #30363d; }
        .error { color: #f85149; }
        .stale-badge {
            font-size: 0.65rem;
            color: #d29922;
            background: rgba(210, 153, 34, 0.15);
            border-radius: 3px;
            padding: 1px 4px;
            margin-left: 4px;
            vertical-align: middle;
            cursor: default;
        }
        #temp-summary {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .temp-chip {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px 16px;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        .temp-chip-source {
            font-size: 0.72rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .temp-chip-temp {
            font-size: 1.6rem;
            font-weight: bold;
            color: #79c0ff;
        }
        .temp-chip-time {
            font-size: 0.78rem;
            color: #6e7681;
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        #countdown {
            font-size: 0.78rem;
            color: #8b949e;
            text-align: right;
            white-space: nowrap;
            padding-top: 2px;
        }
        #countdown span {
            color: #58a6ff;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>
    <div class="header-row">
        <div>
            <h1>NWS Weather Data</h1>
            <div class="subtitle">Denton, TX &nbsp;|&nbsp; 33.2148°N, 97.1331°W</div>
        </div>
        <div id="countdown">Refreshes in <span id="countdown-val">2:00</span></div>
    </div>
    <div id="temp-summary"></div>
    <div id="status">Loading…</div>
    <button id="refresh">Refresh</button>
    <div id="content"></div>

    <script>
        const LAT = 33.2148;
        const LON = -97.1331;
        const OM_URL = 'https://api.open-meteo.com/v1/forecast?latitude=33.21&longitude=-97.13&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FChicago';
        let prevObs = null;

        const WMO_CODES = {
            0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
            45: 'Fog', 48: 'Depositing rime fog',
            51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
            56: 'Light freezing drizzle', 57: 'Heavy freezing drizzle',
            61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
            66: 'Light freezing rain', 67: 'Heavy freezing rain',
            71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow', 77: 'Snow grains',
            80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
            85: 'Slight snow showers', 86: 'Heavy snow showers',
            95: 'Thunderstorm', 96: 'Thunderstorm w/ slight hail', 99: 'Thunderstorm w/ heavy hail'
        };
        function wmoDescription(code) {
            return code != null ? (WMO_CODES[code] ?? `WMO code ${code}`) : null;
        }

        function mergeObs(fresh, prev) {
            if (!prev) return { obs: fresh, stale: new Set() };
            const merged = { ...fresh };
            const stale = new Set();

            const valueProps = [
                'temperature', 'dewpoint', 'windDirection', 'windSpeed', 'windGust',
                'barometricPressure', 'seaLevelPressure', 'visibility', 'relativeHumidity',
                'windChill', 'heatIndex', 'precipitationLastHour',
                'maxTemperatureLast24Hours', 'minTemperatureLast24Hours'
            ];
            for (const key of valueProps) {
                if (fresh[key]?.value == null && prev[key]?.value != null) {
                    merged[key] = prev[key];
                    stale.add(key);
                }
            }

            if (!fresh.textDescription && prev.textDescription) {
                merged.textDescription = prev.textDescription;
                stale.add('textDescription');
            }
            if (!fresh.flightRules && prev.flightRules) {
                merged.flightRules = prev.flightRules;
                stale.add('flightRules');
            }
            if ((!fresh.cloudLayers || fresh.cloudLayers.length === 0) && prev.cloudLayers?.length > 0) {
                merged.cloudLayers = prev.cloudLayers;
                stale.add('cloudLayers');
            }
            if ((!fresh.presentWeather || fresh.presentWeather.length === 0) && prev.presentWeather?.length > 0) {
                merged.presentWeather = prev.presentWeather;
                stale.add('presentWeather');
            }

            return { obs: merged, stale };
        }

        function fmt(val, unit = '') {
            if (val === null || val === undefined) return null;
            return unit ? `${val} ${unit}` : String(val);
        }

        function cToF(c) {
            return c !== null && c !== undefined ? Math.round(c * 9 / 5 + 32) : null;
        }

        function msToMph(mps) {
            return mps !== null && mps !== undefined ? Math.round(mps * 0.621371) : null;
        }

        function mToFt(m) {
            return m !== null && m !== undefined ? Math.round(m * 3.28084) : null;
        }

        function paToInHg(pa) {
            return pa !== null && pa !== undefined ? (pa * 0.0002953).toFixed(2) : null;
        }

        function pctOrNull(v) {
            return v !== null && v !== undefined ? `${Math.round(v)}%` : null;
        }

        function displayVal(v, cls = '') {
            if (v === null || v === undefined) {
                return `<span class="field-value null">—</span>`;
            }
            return `<span class="field-value ${cls}">${v}</span>`;
        }

        function makeSection(title, endpoint, fields, rawObj, gridClass = 'field-grid') {
            const id = 'raw-' + Math.random().toString(36).slice(2);
            return `
                <div class="section">
                    <div class="section-header">
                        <span>${title}</span>
                        <span>
                            <span class="endpoint">${endpoint}</span>
                            <button class="raw-toggle" onclick="toggleRaw('${id}')">JSON</button>
                        </span>
                    </div>
                    <div class="${gridClass}">${fields}</div>
                    <pre class="raw-json" id="${id}">${JSON.stringify(rawObj, null, 2)}</pre>
                </div>`;
        }

        function field(label, value, cls = '', stale = false) {
            const staleTag = stale
                ? ' <span class="stale-badge" title="Using cached value from previous fetch">↺</span>'
                : '';
            return `<div class="field">
                <div class="field-label">${label}${staleTag}</div>
                ${displayVal(value, cls)}
            </div>`;
        }

        function toggleRaw(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        async function _loadWeather() {
            const status = document.getElementById('status');
            const content = document.getElementById('content');
            status.textContent = 'Fetching point data…';
            content.innerHTML = '';

            try {
                // Kick off Open-Meteo in parallel with the NWS chain
                const omPromise = fetch(OM_URL);

                // 1. Points
                const pointRes = await fetch(`https://api.weather.gov/points/${LAT},${LON}`);
                if (!pointRes.ok) throw new Error(`Points API error: ${pointRes.status}`);
                const pointData = await pointRes.json();
                const props = pointData.properties;

                const pointFields =
                    field('Grid Office (CWA)', props.cwa) +
                    field('Grid ID', props.gridId) +
                    field('Grid X', props.gridX) +
                    field('Grid Y', props.gridY) +
                    field('Forecast Zone', props.forecastZone?.split('/').pop()) +
                    field('County', props.county?.split('/').pop()) +
                    field('Fire Weather Zone', props.fireWeatherZone?.split('/').pop()) +
                    field('Time Zone', props.timeZone) +
                    field('Radar Station', props.radarStation) +
                    field('City', props.relativeLocation?.properties?.city) +
                    field('State', props.relativeLocation?.properties?.state);

                // 2. Observation Stations
                status.textContent = 'Fetching observation stations…';
                const stationsRes = await fetch(props.observationStations);
                if (!stationsRes.ok) throw new Error(`Stations API error: ${stationsRes.status}`);
                const stationsData = await stationsRes.json();
                const station = stationsData.features[0];
                const stationProps = station?.properties;
                const stationId = station?.id;

                const stationFields =
                    field('Station ID', stationProps?.stationIdentifier) +
                    field('Station Name', stationProps?.name) +
                    field('Elevation', mToFt(stationProps?.elevation?.value) !== null
                        ? `${mToFt(stationProps.elevation.value)} ft (${stationProps.elevation.value} m)` : null) +
                    field('Time Zone', stationProps?.timeZone) +
                    field('Station URL', stationId);

                // 3. Latest Observation
                status.textContent = 'Fetching latest observation…';
                const obsRes = await fetch(`${stationId}/observations/latest`);
                if (!obsRes.ok) throw new Error(`Observation API error: ${obsRes.status}`);
                const obsData = await obsRes.json();
                const { obs, stale } = mergeObs(obsData.properties, prevObs);

                const tempF = cToF(obs.temperature?.value);
                const dewF = cToF(obs.dewpoint?.value);
                const feelsF = cToF(obs.heatIndex?.value) ?? cToF(obs.windChill?.value);
                const windMph = msToMph(obs.windSpeed?.value);
                const gustMph = msToMph(obs.windGust?.value);
                const visibFt = mToFt(obs.visibility?.value);
                const pressureInHg = paToInHg(obs.barometricPressure?.value);
                const seaLevelInHg = paToInHg(obs.seaLevelPressure?.value);
                const ceilingFt = mToFt(obs.cloudLayers?.[0]?.base?.value);

                const obsTimestamp = obs.timestamp ? new Date(obs.timestamp).toLocaleString() : null;

                const obsFields =
                    field('Description', obs.textDescription, '', stale.has('textDescription')) +
                    field('Temperature', tempF !== null ? `${tempF}°F (${obs.temperature.value?.toFixed(1)}°C)` : null, 'highlight', stale.has('temperature')) +
                    field('Dewpoint', dewF !== null ? `${dewF}°F (${obs.dewpoint.value?.toFixed(1)}°C)` : null, '', stale.has('dewpoint')) +
                    field('Feels Like', feelsF !== null ? `${feelsF}°F` : null, '', stale.has('heatIndex') || stale.has('windChill')) +
                    field('Relative Humidity', pctOrNull(obs.relativeHumidity?.value), '', stale.has('relativeHumidity')) +
                    field('Wind Direction', obs.windDirection?.value !== null ? `${obs.windDirection.value}°` : null, '', stale.has('windDirection')) +
                    field('Wind Speed', windMph !== null ? `${windMph} mph (${obs.windSpeed.value?.toFixed(1)} km/h)` : null, '', stale.has('windSpeed')) +
                    field('Wind Gust', gustMph !== null ? `${gustMph} mph` : null, '', stale.has('windGust')) +
                    field('Barometric Pressure', pressureInHg !== null ? `${pressureInHg} inHg` : null, '', stale.has('barometricPressure')) +
                    field('Sea Level Pressure', seaLevelInHg !== null ? `${seaLevelInHg} inHg` : null, '', stale.has('seaLevelPressure')) +
                    field('Visibility', visibFt !== null ? `${visibFt.toLocaleString()} ft (${(obs.visibility.value / 1000).toFixed(1)} km)` : null, '', stale.has('visibility')) +
                    field('Cloud Ceiling (lowest)', ceilingFt !== null ? `${ceilingFt.toLocaleString()} ft` : null, '', stale.has('cloudLayers')) +
                    field('Cloud Layers', obs.cloudLayers?.length
                        ? obs.cloudLayers.map(l => `${l.amount} @ ${mToFt(l.base?.value)?.toLocaleString() ?? '?'} ft`).join(', ')
                        : null, '', stale.has('cloudLayers')) +
                    field('Wind Chill', obs.windChill?.value != null ? `${cToF(obs.windChill.value)}°F` : null, '', stale.has('windChill')) +
                    field('Heat Index', obs.heatIndex?.value != null ? `${cToF(obs.heatIndex.value)}°F` : null, '', stale.has('heatIndex')) +
                    field('Precipitation Last Hour', obs.precipitationLastHour?.value != null
                        ? `${obs.precipitationLastHour.value} mm` : null, '', stale.has('precipitationLastHour')) +
                    field('Max Temp Last 24h', obs.maxTemperatureLast24Hours?.value != null
                        ? `${cToF(obs.maxTemperatureLast24Hours.value)}°F` : null, '', stale.has('maxTemperatureLast24Hours')) +
                    field('Min Temp Last 24h', obs.minTemperatureLast24Hours?.value != null
                        ? `${cToF(obs.minTemperatureLast24Hours.value)}°F` : null, '', stale.has('minTemperatureLast24Hours')) +
                    field('Present Weather', obs.presentWeather?.map(w => w.rawString || w.intensity).join(', ') || null, '', stale.has('presentWeather')) +
                    field('Flight Rules', obs.flightRules, '', stale.has('flightRules'));

                // 4. Forecast
                status.textContent = 'Fetching forecast…';
                const fcstRes = await fetch(props.forecast);
                if (!fcstRes.ok) throw new Error(`Forecast API error: ${fcstRes.status}`);
                const fcstData = await fcstRes.json();

                const fcstUpdated = fcstData.properties.updateTime
                    ? new Date(fcstData.properties.updateTime).toLocaleString() : '';

                const forecastPeriods = fcstData.properties.periods.map(p => `
                    <div class="forecast-period">
                        <div class="period-name">${p.name}</div>
                        <div class="period-temp ${p.isDaytime ? 'day' : 'night'}">${p.temperature}°${p.temperatureUnit}</div>
                        <div class="period-short">${p.shortForecast}</div>
                        <div class="period-wind">Wind: ${p.windSpeed} ${p.windDirection}</div>
                        <div class="period-detail">${p.detailedForecast}</div>
                    </div>`).join('');

                const updatedLabel = fcstUpdated
                    ? `<div class="updated-at" style="padding:8px 14px">Forecast updated: ${fcstUpdated}</div>` : '';

                // 5. Open-Meteo
                status.textContent = 'Fetching Open-Meteo data…';
                const omRes = await omPromise;
                if (!omRes.ok) throw new Error(`Open-Meteo API error: ${omRes.status}`);
                const omData = await omRes.json();
                const omc = omData.current;
                const omTime = omc.time ? new Date(omc.time).toLocaleString() : null;
                const omInterval = omc.interval != null ? `${omc.interval / 60} min` : null;
                const omElevFt = mToFt(omData.elevation);

                const omFields =
                    field('Observed At', omTime) +
                    field('Temperature', omc.temperature_2m != null ? `${omc.temperature_2m}°F` : null, 'highlight') +
                    field('Relative Humidity', omc.relative_humidity_2m != null ? `${omc.relative_humidity_2m}%` : null) +
                    field('Wind Speed', omc.wind_speed_10m != null ? `${omc.wind_speed_10m} mph` : null) +
                    field('Weather Code', omc.weather_code != null ? `${wmoDescription(omc.weather_code)} (${omc.weather_code})` : null) +
                    field('Update Interval', omInterval) +
                    field('Elevation', omElevFt != null ? `${omElevFt.toLocaleString()} ft (${omData.elevation} m)` : null) +
                    field('Timezone', omData.timezone ? `${omData.timezone} (${omData.timezone_abbreviation})` : null);

                const nwsTimeShort = obs.timestamp
                    ? new Date(obs.timestamp).toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'})
                    : '—';
                const omTimeShort = omc.time
                    ? new Date(omc.time).toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'})
                    : '—';
                document.getElementById('temp-summary').innerHTML = `
                    <div class="temp-chip">
                        <span class="temp-chip-source">NWS</span>
                        <span class="temp-chip-temp">${tempF != null ? `${tempF}°F` : '—'}</span>
                        <span class="temp-chip-time">@ ${nwsTimeShort}</span>
                    </div>
                    <div class="temp-chip">
                        <span class="temp-chip-source">Open-Meteo</span>
                        <span class="temp-chip-temp">${omc.temperature_2m != null ? `${omc.temperature_2m}°F` : '—'}</span>
                        <span class="temp-chip-time">@ ${omTimeShort}</span>
                    </div>`;

                content.innerHTML =
                    makeSection('Latest Observation',
                        `<a href="${stationId}/observations/latest" target="_blank">${stationProps?.stationIdentifier}/observations/latest</a>`, obsFields, obsData) +
                    makeSection('Open-Meteo Current Conditions',
                        `<a href="${OM_URL}" target="_blank">api.open-meteo.com/v1/forecast</a>`, omFields, omData) +
                    makeSection('Point / Grid Info',
                        `api.weather.gov/points/${LAT},${LON}`, pointFields, pointData) +
                    makeSection('Nearest Observation Station',
                        props.observationStations.replace('https://api.weather.gov', ''), stationFields, stationsData) +
                    `<div class="section">
                        <div class="section-header">
                            <span>7-Day Forecast</span>
                            <span class="endpoint">${props.forecast.replace('https://api.weather.gov', '')}</span>
                        </div>
                        <div class="forecast-grid">${forecastPeriods}</div>
                        ${updatedLabel}
                    </div>`;

                status.innerHTML = `Last updated: ${new Date().toLocaleString()}<br>Observed at: ${obsTimestamp ?? '—'}`;
                prevObs = obsData.properties;
            } catch (err) {
                status.innerHTML = `<span class="error">Error: ${err.message}</span>`;
                console.error(err);
            }
        }

        const REFRESH_INTERVAL = 120; // seconds
        let secondsLeft = REFRESH_INTERVAL;
        let countdownTimer = null;
        let autoRefreshTimer = null;

        function formatCountdown(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}:${String(sec).padStart(2, '0')}`;
        }

        function startCountdown() {
            clearInterval(countdownTimer);
            clearTimeout(autoRefreshTimer);
            secondsLeft = REFRESH_INTERVAL;
            document.getElementById('countdown-val').textContent = formatCountdown(secondsLeft);

            countdownTimer = setInterval(() => {
                secondsLeft--;
                document.getElementById('countdown-val').textContent = formatCountdown(secondsLeft);
                if (secondsLeft <= 0) {
                    clearInterval(countdownTimer);
                }
            }, 1000);

            autoRefreshTimer = setTimeout(() => {
                loadWeather();
            }, REFRESH_INTERVAL * 1000);
        }

        async function loadWeather() {
            startCountdown();
            return _loadWeather();
        }

        document.getElementById('refresh').addEventListener('click', loadWeather);
        loadWeather();
    </script>
</body>
</html>
