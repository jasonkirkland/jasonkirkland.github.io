<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magic GAS</title>
    <!-- Vue.js 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- Vuetify 2 -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3"></script>
    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.4/css/materialdesignicons.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Material+Icons" rel="stylesheet" />
    <style>
      .status-icon {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <v-app>
        <v-app-bar class="orange darken-2 white--text" app>
          <v-toolbar-title class="ml-0 pl-4"> Magic Tool</v-toolbar-title>
        </v-app-bar>
        <v-main class="grey lighten-3 pl-4 pr-4">
          <v-container>
            <v-expansion-panels>
              <!--Image download parameters-->
              <v-expansion-panel>
                <v-expansion-panel-header> 1. Download Images</v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-form ref="downloadForm" class="mb-6">
                    <v-text-field
                      label="WP Image Url-Path"
                      color="white"
                      v-model="imagePath"
                      :rules="[v => !!v || 'Image path is required']"
                      required
                      outlined
                    ></v-text-field>

                    <v-textarea
                      label="Enter the data from FB"
                      color="white"
                      v-model="inputText"
                      :rules="[v => !!v || 'At least one URL is required']"
                      required
                      outlined
                    ></v-textarea>

                    <v-btn color="primary" @click="submitForm">Download Images</v-btn>
                    <v-chip class="ma-2" color="grey" text-color="white">
                      <v-avatar left class="grey darken-4"> {{statuses.length}} </v-avatar>
                      Total
                    </v-chip>
                    <v-chip class="ma-2" color="green light-1" text-color="white">
                      <v-avatar left class="green darken-4"> {{details.length}} </v-avatar>
                      Success
                    </v-chip>
                  </v-form>
                </v-expansion-panel-content>
              </v-expansion-panel>

              <!--Titles (from image urls)-->
              <v-expansion-panel :disabled="imageDownloadComplete == false">
                <v-expansion-panel-header> 2. Ask AI to describe each title</v-expansion-panel-header>
                <v-expansion-panel-content>
                  <p style="font-family: monospace">
                    Generate a 1 sentence description of each of the following items. our output format will be: {original line number} - {item name} -
                    {description}
                  </p>
                  <ul style="font-family: monospace">
                    <li v-for="item in detailsSorted">{{(item.index).toString() + ". " + item.title}}</li>
                  </ul>
                </v-expansion-panel-content>
              </v-expansion-panel>

              <!--AI Response-->
              <v-expansion-panel :disabled="imageDownloadComplete == false">
                <v-expansion-panel-header> 3. Paste response from AI</v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-textarea v-model="itemDescriptionsFromAi"> </v-textarea>
                  <v-btn color="primary" @click="generateHtml">Generate Final Html</v-btn>
                </v-expansion-panel-content>
              </v-expansion-panel>

              <!--Final Html for Blog-->
              <v-expansion-panel :disabled="imageDownloadComplete == false">
                <v-expansion-panel-header> 4. Final Html for Blog</v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-textarea v-model="html"></v-textarea>
                  <!--Preview Html-->
                  <!--
                  <br /><br />
                  <ol>
                    <li v-for="d in detailsSorted">
                      <p>
                        <strong>
                          <a :href="d.url">{{d.title}}</a>
                        </strong>
                      </p>
                      &nbsp;
                      <p>{{itemDescriptionFromAi(d.index, d.title)}}</p>
                      <figure class="wp-block-image aligncenter">
                        <a :href="d.url">
                          <img :src="d.imagePath + d.imageTitle + '.jpg'" :alt="d.title" />
                        </a>
                      </figure>
                    </li>
                  </ol>
                -->
                </v-expansion-panel-content>
              </v-expansion-panel>

              <!--end of panels-->
            </v-expansion-panels>
          </v-container>
        </v-main>
      </v-app>
    </div>
    <script>
      new Vue({
        el: "#app",
        vuetify: new Vuetify(),
        data() {
          return {
            inputText: "",
            folderName: "",
            progress: 0,
            imageDownloadComplete: false,
            headers: [
              { text: "URL", value: "url" },
              { text: "Status", value: "status" },
            ],
            statuses: [],
            details: [],
            imagePath: "https://www.farmwifedrinks.com/wp-content/uploads/2023/05/",
            html: "",
            titles: "",
            itemDescriptionsFromAi: "",
          };
        },
        created() {},
        methods: {
          async submitForm() {
            if (this.$refs.downloadForm.validate()) {
              const urlArray = this.extractUrls(this.inputText);
              this.statuses = urlArray.map((url, index) => ({
                url,
                status: { text: "Pending", icon: "mdi-cancel", iconColor: "red" },
              }));
              const downloadPromises = urlArray.map(async (url, index) => {
                await this.downloadImage(url, index);
              });
              await Promise.all(downloadPromises);
              this.imageDownloadComplete = true;

              this.progress = 0;
              //this.downloadZip();
            }
          },
          async downloadZip() {
            const _imageInfo = this.imageInfo;

            const response = await fetch("/downloadZip", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ imageInfo: _imageInfo }),
            });

            if (!response.ok) {
              //throw new Error(`HTTP error! status: ${response.status}`);
              console.log(response.status);
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "images.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          },
          extractUrls(text) {
            const regex = /https?:\/\/[^\s]+/g;
            return text.match(regex);
          },
          async downloadImage(url, index) {
            try {
              var _url = JSON.stringify({
                urls: [url],
              });

              var requestOptions = {
                redirect: "follow",
                method: "POST",
                headers: {
                  "Content-Type": "text/plain;charset=utf-8",
                },
                body: JSON.stringify({ urls: [{ index: index, url: _url }] }),
              };

              const response = await fetch(
                "https://script.google.com/macros/s/AKfycbygeGN8SsUv8t09WSqxByUJdgUNMs3MBkxkZEitOLJV_iYaD9v5IC0juLc25Ih0NX5-/exec",
                requestOptions
              );
              const result = await response.json();
              const icon = "mdi-checkbox-marked-circle";
              const iconColor = "green";
              this.details.push({
                url: result.url,
                imageUrl: result.imageUrl,
                title: result.title,
                index: result.index + 1,
                folderName: result.folderName,
                imageTitle: result.imageTitle,
              });
              this.$set(this.statuses[index], "status", { text: result.imageUrl, icon, iconColor });
            } catch (error) {
              const icon = "mdi-cancel";
              const iconColor = "red";
              this.$set(this.statuses[index], "status", { text: `Error downloading image for URL ${index + 1}: ${url}`, icon, iconColor });
            }
          },
          generateHtml() {
            const _this = this;
            let h =
              '<li><p><strong><a href="{URL}">{TITLE}</a></strong></p> <p>{AI_DESCRIPTION}</p><figure class="wp-block-image aligncenter"><a href="{URL}"><img src="{IMAGE_PATH}{IMAGETITLE}.jpg" alt="{ALT_TITLE}"/></a></figure></li>';
            let _html = "";
            this.details
              .sort((a, b) => {
                return a.index - b.index;
              })
              .forEach((f) => {
                const aiDescription = this.itemDescriptionFromAi(f.index, f.title);
                let z = h
                  .replaceAll("{URL}", f.url)
                  .replaceAll("{TITLE}", f.title)
                  .replaceAll("{ALT_TITLE}", f.title)
                  .replaceAll("{IMAGE_PATH}", _this.imagePath)
                  .replaceAll("{IMAGETITLE}", f.imageTitle)
                  .replaceAll("{AI_DESCRIPTION}", aiDescription);
                _html += z;
              });

            this.html = "<ol>" + _html + "</ol>";
          },
          itemDescriptionFromAi(itemId, title) {
            const inputString = this.itemDescriptionsFromAi;
            const regexPattern = `^${itemId}.*$`;
            const regex = new RegExp(regexPattern, "m");
            const item = inputString.match(regex);

            const final = item == null ? "" : item[0];
            return final.replace(itemId.toString() + " - ", "").replace(title + " - ", "");
          },
        },
        computed: {
          detailsSorted() {
            return this.details.sort((a, b) => {
              return a.index - b.index;
            });
          },
          imageInfo() {
            const urls = [];
            this.details.forEach((d) => urls.push({ imageUrl: d.imageUrl, imageTitle: d.imageTitle }));
            return urls;
          },
        },
      });
    </script>
  </body>
</html>
